<!DOCTYPE html><html domain=realvarez.com ga-id=G-B5XRB3YVTR lang=en><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><link href="/img/favicon/favicon-192x192.png?hash=ae2c3e88f6" rel=icon type=image/png><meta content=#f9c412 name=theme-color><meta content="max-snippet:-1, max-image-preview: large, max-video-preview: -1" name=robots><title>Weak References - A weapon against Out Of Memory Errors</title><meta content="Weak References - A weapon against Out Of Memory Errors" property=og:title><meta content="How to give and receive constructive feedback" name=description><meta content="How to give and receive constructive feedback" property=og:description><meta content=summary_large_image name=twitter:card><meta content=@realz name=twitter:site><meta content=@realz name=twitter:creator><link href=https://blog.realvarez.com/posts/weak-references/ rel=canonical><meta content=no-referrer-when-downgrade name=referrer><link href=/feed/feed.xml rel=alternate type=application/atom+xml title="Re Alvarez Parmar's Blog"><link href=/ rel=preconnect crossorigin=""><link href=/fonts/Inter-3.19.var.woff2 rel=preload type=font/woff2 as=font crossorigin=""><script async defer src="/js/min.js?hash=8db32dcb3a"></script><script async defer src="/js/cached.js?hash=29681a444d"></script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary: #f9c412;--primary-dark: #e7bf60;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{position:fixed;padding:.375em 1.5em;background:rgba(255,255,255,.9);font-weight:200;text-align:right}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px}share-widget div{width:30px;height:30px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center}.apple share-widget div{background-image:url(/img/share-apple.svg)}body,share-widget button{margin:0}share-widget button:active{transform:scale(1.2)}dialog{background-color:#8dff80;z-index:1000}header aside{font-style:italic}#nav{z-index:2;position:relative}#reading-progress,header nav{z-index:1;width:100vw;left:0;top:0}#reading-progress{background-color:var(--primary);position:absolute;bottom:0;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}@font-face{font-display:optional;font-family:"Inter UI";font-weight:100 900;font-style:oblique 0deg 10deg;src:url(/fonts/Inter-3.19.var.woff2) format("woff2")}button,html{line-height:1.15}html{-webkit-text-size-adjust:100%;font-family:Inter UI,sans-serif;--font-family: Inter UI, sans-serif}h1{font-size:3em;line-height:1.25;margin:.67em 0 .5em;font-size:2.074rem}a{background-color:transparent;color:#f9c412;text-decoration:none;color:var(--primary)}strong{font-weight:700}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button{font-family:inherit;font-size:100%;overflow:visible;text-transform:none}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em}h3{font-size:2em;line-height:1.125;margin-bottom:.75em;font-size:1.4rem}h4{font-size:1.5em;margin-bottom:1em;line-height:1.5em}body,p,pre,ul{font-size:1em}p,pre,ul{margin-bottom:1.5em}h1,h2,h3,h4{line-height:2.4rem;margin-bottom:1.36rem}h2{font-size:1.728rem}h3,h4{line-height:1.6rem}h4{font-size:1.2rem}body,p,pre,ul{font-size:1rem;line-height:1.6}p,pre,ul{margin-bottom:1.36rem}@media (min-width:600px){h1{font-size:4.3978rem;line-height:4.4rem}h2{font-size:3.1097rem;line-height:3.52rem}h3{font-size:2.1989rem;line-height:2.64rem}h4{font-size:1.5554rem;line-height:1.76rem}body,p,pre,ul{font-size:1.1rem;line-height:1.6}h1,h2,h3,h4,p,pre,ul{margin-bottom:1.496rem}}@media (min-width:1200px){h1{font-size:6.0756rem;line-height:6.72rem}h2{font-size:4.05rem;line-height:4.8rem}h3{font-size:2.7rem;line-height:2.88rem}h4{font-size:1.8rem;line-height:1.92rem}body,p,pre,ul{font-size:1.2rem;line-height:1.6}h1,h2,h3,h4,p,pre,ul{margin-bottom:1.632rem}}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre:has(code:not([class])){background:#2d2d2d}pre code:not([class]){color:#ccc;padding:0;overflow-x:scroll}button,code{border-radius:.3em}code{color:#e2777a;padding:0 .3em;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%;background:#2d2d2d}h1,h2,h3,h4{font-family:var(--font-family)}h2,h4{font-style:italic}a:hover{text-decoration:underline}dt{font-weight:600;padding-top:.75em;padding-left:.75em}button{max-width:100%;background:#f2f2f2;color:#191919;cursor:pointer;display:inline-block;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}*{border:0;box-sizing:border-box}body,header nav a{font-family:var(--font-family)}body{background:#181818;color:#eee}header{padding:4.5em 1.5em 3em;width:37.5em;margin:0 auto;text-align:center;max-width:100%;display:flex;align-items:center;flex-direction:column}header p,ul{margin-top:0}header nav h1{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav a{font-weight:700;text-decoration:none;color:#181818;margin-left:1.5em}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}main{max-width:70rem;margin:0 auto;border-top:.5px solid #ccc}footer{background:rgba(0,0,0,.8);color:#fff;padding:3em;text-align:center}footer>*{margin:1.5em}footer nav a img{vertical-align:middle}footer nav,footer p{font-size:90%}article{max-width:100%;padding:1.5em;width:37.5em;margin:0 auto}li ul{margin-bottom:0}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]{padding:0}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.comment{color:#999}.token.punctuation{color:#ccc}.token.deleted{color:#e2777a}.token.number{color:#f08d49}.token.property{color:#f8c555}.token.keyword{color:#cc99cd}.token.variable{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.token.inserted{color:green}</style><header><nav><div id=nav><h1><a href=/ title=Homepage>Re Alvarez Parmar's Blog</a></h1><a href=/about/ >About</a></div><div id=reading-progress aria-hidden=true></div></nav><aside>5 min read.</aside><dialog id=message></dialog><noscript><img alt="" height=1 src="/api/ga?v=1&_v=j83&t=pageview&dr=https%3A%2F%2Fno-script.com&_s=1&dh=realvarez.com&dp=%2Fposts%2Fweak-references%2F&ul=en-us&de=UTF-8&dt=Weak%20References%20-%20A%20weapon%20against%20Out%20Of%20Memory%20Errors&tid=G-B5XRB3YVTR" style=display:none width=1></noscript></header><main><article><p>One of the key features that containers offer us is the ability to apply resource control through <a href=https://man7.org/linux/man-pages/man7/cgroups.7.html>Control Groups</a>, generally referred to as cgroups. Containers, which build on top of Linux cgroups, allow us to run process that have limited access to host's total capacity.<p>This ability allows us to co-locate containers on the same host without being concerned that a container may impact other containerized apps, the so called <em>noisy neighbor problem</em>.<p>While cgroups allow us to control many resources, the most used controls are CPU and memory. For scalable, multi-tenant clusters like Kubernetes or Amazon ECS, resource limiting is a best practice.<p>ECS and Kubernetes allow us to limit resource consumption at container and ECS task or Kubernetes pod level. Below are the requests and limits a pod can have:<ul><li><code>spec.containers[].resources.limits.cpu</code><li><code>spec.containers[].resources.limits.memory</code><li><code>spec.containers[].resources.limits.hugepages-</code><li><code>spec.containers[].resources.requests.cpu</code><li><code>spec.containers[].resources.requests.memory</code><li><code>spec.containers[].resources.requests.hugepages-</code></ul><p>Similarly, Docker desktop allows configuring memory and CPU limits. Should a container try to use more memory than allocated, it gets <em>killed</em>.<pre class=language-python><code class=language-python><span class="token punctuation">[</span><span class="token number">336546.736392</span><span class="token punctuation">]</span> Out of memory<span class="token punctuation">:</span> Kill process <span class="token number">9218</span> <span class="token punctuation">(</span>java<span class="token punctuation">)</span> score <span class="token number">330</span> <span class="token keyword">or</span> sacrifice child<br><span class="token punctuation">[</span><span class="token number">336546.738454</span><span class="token punctuation">]</span> Killed process <span class="token number">9218</span> <span class="token punctuation">(</span>java<span class="token punctuation">)</span> total<span class="token operator">-</span>vm<span class="token punctuation">:</span>7543324kB<span class="token punctuation">,</span> test<span class="token operator">-</span>mem<span class="token punctuation">:</span>1060364kB<span class="token punctuation">,</span> test<span class="token operator">-</span>mem2<span class="token punctuation">:</span>0kB<span class="token punctuation">,</span> test<span class="token operator">-</span>mem<span class="token operator">-</span>rar<span class="token punctuation">:</span>0kB<br><span class="token punctuation">[</span><span class="token number">336547.071919</span><span class="token punctuation">]</span> oom_reaper<span class="token punctuation">:</span> reaped process <span class="token number">9218</span> <span class="token punctuation">(</span>java<span class="token punctuation">)</span><span class="token punctuation">,</span> now test<span class="token operator">-</span>mem<span class="token punctuation">:</span>0kB</code></pre><h2 id=memory-limits>Memory Limits <a href=#memory-limits class=direct-link>#</a></h2><p>Many enterprises are in the process of moving legacy applications to containers clusters. Some of these applications ran on dedicated hardware. Their business requirements didn’t include operating with resource constraints.<p>Having dedicated resources meant that traditional applications were free to consume as much system resources as available. Although Java allows us to control the heap size, it is rarely used to restrict memory usage for production applications.<p>When these applications migrate to containers and a limit is put upon their memory consumption, new out of memory errors may emerge. A common remedy is to allocate more memory until the application stops crashing.<p>In many cases, that might be the best solution. Pay a bit more of RAM, and move on. Code rot makes changes expensive with each passing day. But if you do have the resources to refactor code, optimizing memory consumption will improve the reliability of your applications.<h2 id=%F0%9F%A7%B9-garbage-collection>🧹 Garbage Collection <a href=#%F0%9F%A7%B9-garbage-collection class=direct-link>#</a></h2><p>One question we may want to ask ourselves is: What are some of the common ways of using memory inefficiently? Once you’ve fixed all the memory leaks, what’s next?<p>C programmers had to manage memory manually using malloc() and free(). Thankfully, higher-level languages automatically allocate memory when programs create objects and free memory when the object is not required.<p>When a process creates a new object, the system will allocate it memory and return the pointer to the program. Typically, a program’s variables (or objects) will remain in memory as long as the code is running. In programming languages like Python, objects include a reference count field, which counts how many objects are referencing it. JavaScript object has a reference to its prototype (implicit reference) and to its properties values (explicit reference). As long as an object has a non-zero reference, it’s immune to garbage collection.<p>Once the process terminates, the garbage controller is free to remove the associated objects from memory as they don’t have any references. Objects created like these have a strong reference, which is the default behavior in all programming languages. They remain in memory until the process terminates.<h3 id=%F0%9F%91%89%F0%9F%8F%BC-weak-referencing>👉🏼 Weak Referencing <a href=#%F0%9F%91%89%F0%9F%8F%BC-weak-referencing class=direct-link>#</a></h3><p>One way to reduce memory consumption is by decreasing the amount and size of the objects stored in memory.<p>Many languages also support creating objects with weak reference. Garbage collectors can remove any variable stored with weak reference even while the process that created it is still running. This provides an excellent way to store objects in memory that can be safely removed if the system comes under memory pressure.<p>Weak Reference objects allow applications to safely build caches without risking running out of memory.<h3 id=%F0%9F%8F%81-downsides-of-weak-referencing>🏁 Downsides of weak referencing <a href=#%F0%9F%8F%81-downsides-of-weak-referencing class=direct-link>#</a></h3><p>Weak referencing forms the foundation for caching. And, similar to caching, it requires <em>getting and setting</em> a variable before usage. So, checking a variable if it exists before reading or writing to it is necessary for weak references.<p>Can you imaging what would happen if a process tries to read its variable that’s stored as a weak reference, and the garbage controller has deleted it? Nothing good.<h3 id=%F0%9F%8E%9A-different-levels-of-weak-references>🎚 Different levels of weak references <a href=#%F0%9F%8E%9A-different-levels-of-weak-references class=direct-link>#</a></h3><p>In addition to the weak references described above, languages like Java provide <em>Soft References</em> and <em>Phantom References.</em> Here's an <a href=https://dzone.com/articles/weak-soft-and-phantom-references-in-java-and-why-they-matter>article</a> that goes over the differences. The TLDR is that the garbage collector removes weak references first, then soft references, and finally phantom references.<p>If your language provides different levels of weak references, consider choosing one that suits your application's requirements.<h3 id=%F0%9F%AB%B1%F0%9F%8F%BD%E2%80%8D%F0%9F%AB%B2%F0%9F%8F%BC-external-caching>🫱🏽‍🫲🏼 External caching <a href=#%F0%9F%AB%B1%F0%9F%8F%BD%E2%80%8D%F0%9F%AB%B2%F0%9F%8F%BC-external-caching class=direct-link>#</a></h3><p>If your application runs multiple replicas or if multiple processes are caching similar data, consider using Redis or Memcached as an external, distributed, and shared cache. These caching solutions are excellent for web services as they allow multiple replicas to share a cache, which allow us to store user’s sessions state without requiring sticky sessions.<h2 id=%F0%9F%8F%86-bonus-tip>🏆 Bonus tip <a href=#%F0%9F%8F%86-bonus-tip class=direct-link>#</a></h2><p>Another common cause for OOM errors in web applications is not keeping the payload size minimal. Web servers stores data for every session in memory until the session terminates. When a client requests a large payload, and the server doesn’t limit it, the systems stores the payload in memory before it is sent to the client.<p>We can limit the payload size by restricting the maximum amount of data sent to a particular client. For example, you can paginate results from a database instead of sending the entire dataset to the client.<h2 id=references>References <a href=#references class=direct-link>#</a></h2><p><a href=https://docs.python.org/3/library/weakref.html>weakref — Weak references — Python 3.10.4 documentation</a><p><a href=https://indradhanush.github.io/blog/life-of-a-container/ >Life of a Container</a><p><a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Memory_Management>Memory Management - JavaScript | MDN</a></p><share-widget><button aria-label=Share href=https://blog.realvarez.com/posts/weak-references/ on-click=share><div></div></button></share-widget><script type=application/ld+json>{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "Weak References - A weapon against Out Of Memory Errors",
  "image": [],
  "author": "", 
  "genre": "Insert a schema.org genre", 
  "publisher": {
    "@type": "Organization",
    "name": "",
    "logo": {
      "@type": "ImageObject",
      "url": "/img/favicon/favicon-192x192.png?hash=ae2c3e88f6"
    }
  },
  "url": "https://blog.realvarez.com/posts/weak-references/",
  "mainEntityOfPage": "https://blog.realvarez.com/posts/weak-references/",
  "datePublished": "2022-05-28",
  "dateModified": "2023-04-09",
  "description": "One of the key features that containers offer us is the ability to apply resource control through Control Groups, generally referred to as..."
}</script><p>Published <time datetime=2022-05-28>28 May 2022</time></article></main><footer><a href=/about/ ></a></footer>