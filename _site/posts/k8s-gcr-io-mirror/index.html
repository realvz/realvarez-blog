<!DOCTYPE html><html domain=realvarez.com ga-id=G-B5XRB3YVTR lang=en><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=/favicon.svg rel=icon type=image/svg+xml><meta content=#f9c412 name=theme-color><meta content="max-snippet:-1, max-image-preview: large, max-video-preview: -1" name=robots><title>Use containerd to handle k8s.gcr.io deprecation</title><meta content="Use containerd to handle k8s.gcr.io deprecation" property=og:title><meta content="How to use containerd mirror feature" name=description><meta content="How to use containerd mirror feature" property=og:description><meta content=summary_large_image name=twitter:card><meta content=@realz name=twitter:site><meta content=@realz name=twitter:creator><link href=https://blog.realvarez.com/posts/k8s-gcr-io-mirror/ rel=canonical><meta content=no-referrer-when-downgrade name=referrer><link href=/feed/feed.xml rel=alternate type=application/atom+xml title="Re Alvarez Parmar's Blog"><link href=/ rel=preconnect crossorigin=""><link href=/fonts/Inter-3.19.var.woff2 rel=preload type=font/woff2 as=font crossorigin=""><script async defer src="/js/min.js?hash=8db32dcb3a"></script><script async defer src="/js/cached.js?hash=29681a444d"></script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary: #f9c412;--primary-dark: #e7bf60;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{position:fixed;padding:.375em 1.5em;background:rgba(255,255,255,.9);font-weight:200;text-align:right}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px}share-widget div{width:30px;height:30px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center}.apple share-widget div{background-image:url(/img/share-apple.svg)}body,share-widget button{margin:0}share-widget button:active{transform:scale(1.2)}dialog{background-color:#8dff80;z-index:1000}header aside{font-style:italic}#nav{z-index:2;position:relative}#reading-progress,header nav{z-index:1;width:100vw;left:0;top:0}#reading-progress{background-color:var(--primary);position:absolute;bottom:0;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}@font-face{font-display:optional;font-family:"Inter UI";font-weight:100 900;font-style:oblique 0deg 10deg;src:url(/fonts/Inter-3.19.var.woff2) format("woff2")}button,html{line-height:1.15}html{-webkit-text-size-adjust:100%;font-family:Inter UI,sans-serif;--font-family: Inter UI, sans-serif}h1{font-size:3em;line-height:1.25;margin:.67em 0 .5em;font-size:2.074rem}a{background-color:transparent;color:#f9c412;text-decoration:none;color:var(--primary)}b,strong{font-weight:700}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button{font-family:inherit;font-size:100%;overflow:visible;text-transform:none}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em}h1,h2,h4{margin-bottom:1.36rem}h4{font-size:1.5em;margin-bottom:1em;line-height:1.5em;line-height:1.6rem;font-size:1.2rem}body,ol,p,pre,ul{font-size:1em}ol,p,pre,ul{margin-bottom:1.5em}h1,h2{line-height:2.4rem}h2{font-size:1.728rem}body,ol,p,pre,ul{font-size:1rem;line-height:1.6}ol,p,pre,ul{margin-bottom:1.36rem}@media (min-width:600px){h1{font-size:4.3978rem;line-height:4.4rem}h2{font-size:3.1097rem;line-height:3.52rem}h4{font-size:1.5554rem;line-height:1.76rem}body,ol,p,pre,ul{font-size:1.1rem;line-height:1.6}h1,h2,h4,ol,p,pre,ul{margin-bottom:1.496rem}}@media (min-width:1200px){h1{font-size:6.0756rem;line-height:6.72rem}h2{font-size:4.05rem;line-height:4.8rem}h4{font-size:1.8rem;line-height:1.92rem}body,ol,p,pre,ul{font-size:1.2rem;line-height:1.6}h1,h2,h4,ol,p,pre,ul{margin-bottom:1.632rem}}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre:has(code:not([class])){background:#2d2d2d}pre code:not([class]){color:#ccc;padding:0;overflow-x:scroll}button,code{border-radius:.3em}code{color:#e2777a;padding:0 .3em;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%;background:#2d2d2d}h1,h2,h4{font-family:var(--font-family)}h2,h4{font-style:italic}a:hover{text-decoration:underline}dt{font-weight:600;padding-top:.75em;padding-left:.75em}button{max-width:100%;background:#f2f2f2;color:#191919;cursor:pointer;display:inline-block;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}*{border:0;box-sizing:border-box}body,header nav a{font-family:var(--font-family)}body{background:#181818;color:#eee}header{padding:4.5em 1.5em 3em;width:37.5em;margin:0 auto;text-align:center;max-width:100%;display:flex;align-items:center;flex-direction:column}header p,ol,ul{margin-top:0}header nav h1{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav a{font-weight:700;text-decoration:none;color:#181818;margin-left:1.5em}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}main{max-width:70rem;margin:0 auto;border-top:.5px solid #ccc}footer{background:rgba(0,0,0,.8);color:#fff;padding:3em;text-align:center}footer>*{margin:1.5em}footer nav a img{vertical-align:middle}footer nav,footer p{font-size:90%}article{max-width:100%;padding:1.5em;width:37.5em;margin:0 auto}li ol,li ul{margin-bottom:0}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]{padding:0}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.comment{color:#999}.token.punctuation{color:#ccc}.token.function,.token.number{color:#f08d49}.token.property{color:#f8c555}.token.string,.token.variable{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.token.inserted{color:green}</style><header><nav><div id=nav><h1><a href=/ title=Homepage>Re Alvarez Parmar's Blog</a></h1><a href=/about/ >About</a></div><div id=reading-progress aria-hidden=true></div></nav><aside>6 min read.</aside><dialog id=message></dialog><noscript><img alt="" height=1 src="/api/ga?v=1&_v=j83&t=pageview&dr=https%3A%2F%2Fno-script.com&_s=1&dh=realvarez.com&dp=%2Fposts%2Fk8s-gcr-io-mirror%2F&ul=en-us&de=UTF-8&dt=Use%20containerd%20to%20handle%20k8s.gcr.io%20deprecation&tid=G-B5XRB3YVTR" style=display:none width=1></noscript></header><main><article><p>The Kubernetes community is getting ready for yet another major change. Until fall of 2022, <code>k8s.gcr.io</code> container registry hosted many Kubernetes community-managed containers images like Cluster Autoscaler, metrics-server, cluster-proportional-autoscaler. The “<a href=http://gcr.io>gcr.io</a>” part in the registry is Google Cloud Registry. In order to be vendor neutral, the community is moving away from using Google Cloud Registry to host container images.<p>As a result, starting March 20th, traffic from the old <code>k8s.gcr.io</code> registry is being redirected to <code>registry.k8s.io</code>. The older <code>k8s.gcr.io</code> will remain functioning for sometime but it is eventually getting deprecated.<p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/vazCd-1920w.avif 1920w, /img/remote/vazCd-1280w.avif 1280w, /img/remote/vazCd-640w.avif 640w, /img/remote/vazCd-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/vazCd-1920w.webp 1920w, /img/remote/vazCd-1280w.webp 1280w, /img/remote/vazCd-640w.webp 640w, /img/remote/vazCd-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/vazCd-1920w.jpg 1920w, /img/remote/vazCd-1280w.jpg 1280w, /img/remote/vazCd-640w.jpg 640w, /img/remote/vazCd-320w.jpg 320w" type=image/jpeg><img alt=Image.jpeg height=266 src=/img/remote/vazCd-1920w.jpg style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1820 266'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAABYlAAAWJQFJUiTwAAAAnklEQVQImT3L7Q6CIACFYUAs18efFF1mqSlBmrWuWNDJFLRr7HNtz94/Zwc0jjPyk85Tw2i/3+ksGbJkSGPD6VgwnSWGU3Om7zLaHyKdHYc07qNQWBZo16vpVo4X/rhXY1VM1/LLsNxwqrZB526U7ynf64jXLhcSY2nbAmOBEJAz+7MRFZA+CpVPOuKqgDTzmcS4hrAG4E9A+IPQ6/wEEtQxfQh7yIYAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)" width=1820 decoding=async loading=lazy></picture><h2 id=what%E2%80%99s-the-impact%3F>What’s the impact? <a href=#what%E2%80%99s-the-impact%3F class=direct-link>#</a></h2><p>The change that occurred six days after Pi day is unlikely to cause major problems. There are some edge cases. But unless you operate in an airgapped or highly restrictive environment that applies strict domain name access controls, you won’t notice the change.<p>This doesn’t mean that there’s no action required. Now is the time to scan code repositories and clusters for usage of the old registry. Failing to act will result in cluster components failing.<p>Once the old registry goes away, <strong>Kubernetes will not be able to create new Pods</strong> (unless image is cached) if the container uses an image hosted on <code>k8s.gcr.io</code>.<h2 id=what-do-you-need-to-change%3F>What do you need to change? <a href=#what-do-you-need-to-change%3F class=direct-link>#</a></h2><p>Cluster owners and development teams have to ensure they are not using any images stored in the old registry. The change is fairly simple. It's pretty simple, really.<p>You need to change your manifests to use <code>registry.k8s.io</code> container registry.<p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/ZIyEAE-1920w.avif 1920w, /img/remote/ZIyEAE-1280w.avif 1280w, /img/remote/ZIyEAE-640w.avif 640w, /img/remote/ZIyEAE-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/ZIyEAE-1920w.webp 1920w, /img/remote/ZIyEAE-1280w.webp 1280w, /img/remote/ZIyEAE-640w.webp 640w, /img/remote/ZIyEAE-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/ZIyEAE-1920w.png 1920w, /img/remote/ZIyEAE-1280w.png 1280w, /img/remote/ZIyEAE-640w.png 640w, /img/remote/ZIyEAE-320w.png 320w" type=image/png><img alt=Image.png height=304 src=/img/remote/ZIyEAE-1920w.png style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1320 304'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAECAYAAACHtL/sAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA/klEQVQYlWMQU+GVYWBlkGbkY5BhEmKQZhRlkOWWYxMNP/iJIeLw18LIw18tY45+ZjAIDuFhYGCAYHYGHgYmBh4GEQZeBjkdsd+qRnI/ZDVFfkipC/2QVOH9I6mv8CJk5/MlkUe+vYw6/uun2/zDlYLyHLdUDGX/yGuLfZFSE/wqrS70RVSZ9zeDmCr/T0MbrW9apkrfFXQkviloivyW1Fd4HrLrBdSA31/dZ+8u4RJjuKZmrABS915OS/SDnJboexFF7m8MvNJsEhzijOI8kiziDBwM4gw8DJIcUsxC4Yc+g7yQG3nkm0n0yb8M0hYGPCxCDDzsIlDng7wCZAMAlXhLwUab4pUAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)" width=1320 decoding=async loading=lazy></picture><p>You can find out which Pods use the old registry using <code>kubectl</code>:<pre class=language-bash><code class=language-bash>kubectl get pods --all-namespaces -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">"{.items[*].spec.containers[*].image}"</span> <span class="token operator">|</span><span class="token punctuation">\</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token number">31</span><span class="token punctuation">;</span>37M0<span class="token punctuation">;</span><span class="token number">31</span><span class="token punctuation">;</span>38m<br><span class="token function">tr</span> -s <span class="token string">'[[:space:]]'</span> <span class="token string">'\n'</span> <span class="token operator">|</span><span class="token punctuation">\</span><br><span class="token function">sort</span> <span class="token operator">|</span><span class="token punctuation">\</span><br><span class="token function">uniq</span> -c <span class="token operator">|</span> <span class="token function">grep</span> -i gcr.io</code></pre><p>Here are the Pods in my test cluster that use the old registry:<p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/YG0KP-1920w.avif 1920w, /img/remote/YG0KP-1280w.avif 1280w, /img/remote/YG0KP-640w.avif 640w, /img/remote/YG0KP-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/YG0KP-1920w.webp 1920w, /img/remote/YG0KP-1280w.webp 1280w, /img/remote/YG0KP-640w.webp 640w, /img/remote/YG0KP-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/YG0KP-1920w.jpg 1920w, /img/remote/YG0KP-1280w.jpg 1280w, /img/remote/YG0KP-640w.jpg 640w, /img/remote/YG0KP-320w.jpg 320w" type=image/jpeg><img alt=Image.jpeg height=220 src=/img/remote/YG0KP-1920w.jpg style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 942 220'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAECAIAAAAI1ii7AAAACXBIWXMAABYlAAAWJQFJUiTwAAAAqklEQVQImQXByRKCIAAAUI9tTlOAGikgIpughjagHvr/v+q9bI5iWEg4jItCLcwn6VMvAhGB8AljA0B7Lboc8Rvs8js9ZeOu1k2sSYRd+dSbhY1Juih8knpl5sv1yvoPkYESix70nPldpUNvu4w/52NPDKS2oAYxi2r1xBo0FjYW1RqW7Q3Sc8bGl57fasJqbsSIuavaoeo8Jq5sLMIaUFcyV3JXEQ0Qu/wB/XUbTr8l42gAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)" width=942 decoding=async loading=lazy></picture><p>These are the at-risk Pods. I’ll have to update the container registry used in the Pods.<p>When hunting for references to old registry, be sure to include containers that may not be currently running in your cluster.<h2 id=what-if-i-don%E2%80%99t-control-the-workloads%3F>What if I don’t control the workloads? <a href=#what-if-i-don%E2%80%99t-control-the-workloads%3F class=direct-link>#</a></h2><p>One of my colleagues raised an intriguing question. Is there’s a way to handle this change at a cluster level? He had a valid concern. Many large enterprises might not be able to implement this change in time before the community sunsets <code>k8s.gcr.io</code>.<p>I work with many customers that manage large Kubernetes clusters, but have little control over the workloads that get deployed into the cluster. Some of these clusters are shared by hundreds of development teams. The burden is on Central Platform Engineering teams to dissipate this information to individual dev teams (who are busy writing code and not checking Kubernetes news!).<p>So, what can these teams do to make sure when the old registry finally croaks, they don’t get paged for in the middle of the night for <code>ErrImagePull</code> and <code>ImagePullBackOff</code>errors?<p>Turns out you can use containerd to handle this redirection at node level. Let’s find out how.<h2 id=using-mirrors-in-containerd>Using mirrors in containerd <a href=#using-mirrors-in-containerd class=direct-link>#</a></h2><p>Ever since Dockerhub started rate limiting image pulls, many have opted to store images in local registries. Mirrors save network bandwidth, reduce image pull time, and don’t rate-limit.<p>You can configure <code>registry.k8s.io</code> as a mirror to <code>k8s.gcr.io</code> in containerd. This configuration will <strong>automatically pull images from <code>registry.k8s.io</code></strong> whenever a Pod uses an image stored in <code>k8s.gcr.io</code>.<p>On your worker node, append these lines in the containerd config file at <code>/etc/containerd/config.toml</code>:<pre class=language-bash><code class=language-bash><span class="token punctuation">[</span>plugins.<span class="token string">"io.containerd.grpc.v1.cri"</span>.registry<span class="token punctuation">]</span><br>   config_path <span class="token operator">=</span> <span class="token string">"/etc/containerd/certs.d"</span></code></pre><p>The final file on an Amazon EKS cluster looks like this:<pre class=language-yaml><code class=language-yaml>version = 2<br>root = "/var/lib/containerd"<br>state = "/run/containerd"<br><br><span class="token punctuation">[</span>grpc<span class="token punctuation">]</span><br>address = "/run/containerd/containerd.sock"<br><br><span class="token punctuation">[</span>plugins."io.containerd.grpc.v1.cri".containerd<span class="token punctuation">]</span><br>default_runtime_name = "runc"<br><br><span class="token punctuation">[</span>plugins."io.containerd.grpc.v1.cri"<span class="token punctuation">]</span><br>sandbox_image = "602401143452.dkr.ecr.us<span class="token punctuation">-</span>west<span class="token punctuation">-</span>2.amazonaws.com/eks/pause<span class="token punctuation">:</span>3.5"<br><br><span class="token punctuation">[</span>plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc<span class="token punctuation">]</span><br>runtime_type = "io.containerd.runc.v2"<br><br><span class="token punctuation">[</span>plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options<span class="token punctuation">]</span><br>SystemdCgroup = true<br><br><span class="token punctuation">[</span>plugins."io.containerd.grpc.v1.cri".cni<span class="token punctuation">]</span><br>bin_dir = "/opt/cni/bin"<br>conf_dir = "/etc/cni/net.d"<br><br><span class="token punctuation">[</span>plugins."io.containerd.grpc.v1.cri".registry<span class="token punctuation">]</span><br>config_path = "/etc/containerd/certs.d"</code></pre><p>Next, create a directory called <code>k8s.gcr.io</code> and a <code>hosts.toml</code> file inside it:<pre class=language-bash><code class=language-bash><span class="token function">mkdir</span> -p /etc/containerd/certs.d/k8s.gcr.io<br><br><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token punctuation bash"> <span class="token operator">></span> /etc/containerd/certs.d/k8s.gcr.io/hosts.toml</span><br>server = "https://k8s.gcr.io"<br><br>[host."https://registry.k8s.io"]<br>capabilities = ["pull", "resolve"]<br>EOF</span></code></pre><p>Image pull requests to <code>k8s.gcr.io</code> will now be sent to <code>registry.k8s.io</code>.<p>Restart containerd and kubelet for the change to take effect.<pre class=language-bash><code class=language-bash>systemctl restart containerd kubelet</code></pre><p>Let’s validate that images are indeed getting pulled from the new registry. I added an entry to my <code>/etc/hosts</code> file to break <code>k8s.gcr.io</code>:<p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/1n10Jr-1920w.avif 1920w, /img/remote/1n10Jr-1280w.avif 1280w, /img/remote/1n10Jr-640w.avif 640w, /img/remote/1n10Jr-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/1n10Jr-1920w.webp 1920w, /img/remote/1n10Jr-1280w.webp 1280w, /img/remote/1n10Jr-640w.webp 640w, /img/remote/1n10Jr-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/1n10Jr-1920w.png 1920w, /img/remote/1n10Jr-1280w.png 1280w, /img/remote/1n10Jr-640w.png 640w, /img/remote/1n10Jr-320w.png 320w" type=image/png><img alt=Image.png height=188 src=/img/remote/1n10Jr-1920w.png style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1314 188'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAArklEQVQImV3JzW6CQABFYXathQiViSAwIDM4jCN/UYhs+v6PdUyw3XRxc77keu55QU8Fasho5xo1FuhJbqvHHLsozL3i2OzJ7IHMxqQm+vVhc34V5DZG6ACvGVKkjbg9JMuPpVsq3CwZV42bS8ZVMawNdq459ynl7UhxFZy75G0nqPvT9qUmxNNdjBkEbkq49DGyDSjMF7L1yY2/OWl8hAqIqk/C8oPwr//8Xe14AXwTUbaUoRu8AAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)" width=1314 decoding=async loading=lazy></picture><p>Containerd can no longer pull an image from <code>k8s.gcr.io</code><p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/g5IJv-1920w.avif 1920w, /img/remote/g5IJv-1280w.avif 1280w, /img/remote/g5IJv-640w.avif 640w, /img/remote/g5IJv-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/g5IJv-1920w.webp 1920w, /img/remote/g5IJv-1280w.webp 1280w, /img/remote/g5IJv-640w.webp 640w, /img/remote/g5IJv-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/g5IJv-1920w.jpg 1920w, /img/remote/g5IJv-1280w.jpg 1280w, /img/remote/g5IJv-640w.jpg 640w, /img/remote/g5IJv-320w.jpg 320w" type=image/jpeg><img alt=Image.jpeg height=188 src=/img/remote/g5IJv-1920w.jpg style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2134 188'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAABoAAAACCAIAAADJrVtvAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAf0lEQVQImS2MWRLCIBAFcweBbMOwGAzMhJSSifc/mhX1s1/1666did9LkVAkZAmuDsB6LgrJIJu4j1yBJayHA9LIxpIG0pa0ZQN0mW7rr/2L3dIwvWw+fDljlpDPmBo+DreKX8XHJ2BW931ydfR1mK+W+j2B9FRuyAa3/p8m9QG/FhU8lmCucwAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)" width=2134 decoding=async loading=lazy></picture><p>I can tell <code>ctr</code> to use the mirror by specifying the <code>—hosts-dir</code> parameter:<pre class=language-bash><code class=language-bash>ctr images pull --hosts-dir <span class="token string">"/etc/containerd/certs.d"</span> k8s.gcr.io/pause:latest</code></pre><p>This time the operation succeeds.<p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/1eTLuA-1920w.avif 1920w, /img/remote/1eTLuA-1280w.avif 1280w, /img/remote/1eTLuA-640w.avif 640w, /img/remote/1eTLuA-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/1eTLuA-1920w.webp 1920w, /img/remote/1eTLuA-1280w.webp 1280w, /img/remote/1eTLuA-640w.webp 640w, /img/remote/1eTLuA-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/1eTLuA-1920w.jpg 1920w, /img/remote/1eTLuA-1280w.jpg 1280w, /img/remote/1eTLuA-640w.jpg 640w, /img/remote/1eTLuA-320w.jpg 320w" type=image/jpeg><img alt=Image.jpeg height=540 src=/img/remote/1eTLuA-1920w.jpg style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2128 540'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAECAIAAADec/LeAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAkElEQVQImT3N0Q6CIBQAUF5rYSqBXEG8sJwIXGzV/39bs7a2837Y+vbra0bSSDAXjTRihVBN2E3Y7Uw6PDWU9pAbZqKYSf+5MvxAFL2/dP6sIh+2Zti4ipx5grCPSIAVfIUjqRormE2opZELnx7CUAt0HcuVYdEuSZNuU5Y2SZeVy8omabNEAlh7eW86PLVfHxd1FX8/5vUxAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)" width=2128 decoding=async loading=lazy></picture><p>Any Pods I create now onwards will use the new registry even though the manifests reference old registry. Here’s a test using a pause container.<pre class=language-bash><code class=language-bash>kubectl create deployment pause --image k8s.gcr.io/pause</code></pre><p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/ZaY3BC-1920w.avif 1920w, /img/remote/ZaY3BC-1280w.avif 1280w, /img/remote/ZaY3BC-640w.avif 640w, /img/remote/ZaY3BC-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/ZaY3BC-1920w.webp 1920w, /img/remote/ZaY3BC-1280w.webp 1280w, /img/remote/ZaY3BC-640w.webp 640w, /img/remote/ZaY3BC-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/ZaY3BC-1920w.jpg 1920w, /img/remote/ZaY3BC-1280w.jpg 1280w, /img/remote/ZaY3BC-640w.jpg 640w, /img/remote/ZaY3BC-320w.jpg 320w" type=image/jpeg><img alt=Image.jpeg height=432 src=/img/remote/ZaY3BC-1920w.jpg style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2484 432'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAADCAIAAAD+5KMAAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAl0lEQVQImSXC6w6CIBgAUH+GroXoVjbDCwIfIpC3EFbv/1qtdXYS7bmJ0kYYX4MJ4KIaPZ8O6aIyAbQXnavvqqygrIDcgFRQVJJcBU5sUOvHzO9Je+Ei2APE3KqVGQ/jzmFlmKaXB/rH9IQpyltE+ixRG7MBpkPCzrQXahuYq4cnhaWXS8fnpmwz0qR5g34pwhSRLivY+QvOPBerabvY5gAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)" width=2484 decoding=async loading=lazy></picture><p>Perfect! Kubernetes could create Pods even though I blocked <code>k8s.gcr.io</code> on the node.<h2 id=what%E2%80%99s-the-best-way-to-implement-this-in-production%3F>What’s the best way to implement this in production? <a href=#what%E2%80%99s-the-best-way-to-implement-this-in-production%3F class=direct-link>#</a></h2><p>In my little demo, I changed a single node in the cluster. What about the rest of the nodes?<p>There are three ways you can use to implement this change on every node in your cluster:<ol><li>The easiest way is to use a daemonset to change to containerd config.toml and add hosts.toml file. IBM cloud has shared <a href=https://raw.githubusercontent.com/IBM-Cloud/kube-samples/master/containerd-registry-daemonset-example>this</a> on Github<li>You can use <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/user-data.html>EC2 user data</a> or <a href=https://aws.amazon.com/systems-manager/ >AWS Systems Manager</a> to make this change when a node gets created<li>You can <a href=https://docs.aws.amazon.com/eks/latest/userguide/eks-ami-build-scripts.html>create your own AM</a>I</ol><h2 id=what-if-i-use-docker-as-runtime%3F>What if I use Docker as runtime? <a href=#what-if-i-use-docker-as-runtime%3F class=direct-link>#</a></h2><p>Starting Kubernetes version <code>1.24</code>, containerd is the only runtime available in Amazon EKS AMIs. If you have an edge case that requires using Docker, there's still hope.<p>Docker also has support for registry mirrors. <a href=https://docs.docker.com/registry/recipes/mirror/#configure-the-docker-daemon>Here’s</a> the documentation page you need.<h2 id=don%E2%80%99t-rely-on-stop-gaps>Don’t rely on stop gaps <a href=#don%E2%80%99t-rely-on-stop-gaps class=direct-link>#</a></h2><p>While the solution included in this post works, I recommend only using as a safety measure. The main reason is that you’ll need to customize the Amazon EKS AMI or create your own AMI to use it.<p>You’ll have less operational overhead if you can simply use EKS AMIs as is. The best way to handle this registry deprecation is to update manifests.<p>Oh, and by the way, you can also use mirrors to enforce pull through cache.</p><share-widget><button aria-label=Share href=https://blog.realvarez.com/posts/k8s-gcr-io-mirror/ on-click=share><div></div></button></share-widget><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","headline":"Use containerd to handle k8s.gcr.io deprecation","image":["https://blog.realvarez.com/img/remote/vazCd-1920w.jpg","https://blog.realvarez.com/img/remote/ZIyEAE-1920w.png","https://blog.realvarez.com/img/remote/YG0KP-1920w.jpg","https://blog.realvarez.com/img/remote/1n10Jr-1920w.png","https://blog.realvarez.com/img/remote/g5IJv-1920w.jpg","https://blog.realvarez.com/img/remote/1eTLuA-1920w.jpg","https://blog.realvarez.com/img/remote/ZaY3BC-1920w.jpg"],"author":"","genre":"Insert a schema.org genre","publisher":{"@type":"Organization","name":"","logo":{"@type":"ImageObject","url":"/img/favicon/favicon-192x192.png?hash=ae2c3e88f6"}},"url":"https://blog.realvarez.com/posts/k8s-gcr-io-mirror/","mainEntityOfPage":"https://blog.realvarez.com/posts/k8s-gcr-io-mirror/","datePublished":"2023-04-04","dateModified":"2023-04-09","description":"The Kubernetes community is getting ready for yet another major change. Until fall of 2022, k8s.gcr.io container registry hosted many..."}</script><p>Published <time datetime=2023-04-04>04 Apr 2023</time></article></main><footer><a href=/about/ ></a></footer>