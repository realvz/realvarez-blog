<!DOCTYPE html><html domain=realvarez.com ga-id=G-B5XRB3YVTR lang=en><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=/favicon.svg rel=icon type=image/svg+xml><meta content=#f9c412 name=theme-color><meta content="max-snippet:-1, max-image-preview: large, max-video-preview: -1" name=robots><title>Reduce Amazon EKS cost by scaling node groups to zero</title><meta content="Reduce Amazon EKS cost by scaling node groups to zero" property=og:title><meta content="This post describes how to scale Amazon EKS managed node groups to zero to save on cossts" name=description><meta content="This post describes how to scale Amazon EKS managed node groups to zero to save on cossts" property=og:description><meta content=summary_large_image name=twitter:card><meta content=@realz name=twitter:site><meta content=@realz name=twitter:creator><meta content=https://blog.realvarez.com/img/remote/ZayYlG.jpg property=og:image><link href=https://blog.realvarez.com/posts/scale-eks-mng-to-zero/ rel=canonical><meta content=no-referrer-when-downgrade name=referrer><link href=/feed/feed.xml rel=alternate type=application/atom+xml title="Re Alvarez Parmar's Blog"><link href=/ rel=preconnect crossorigin=""><link href=/fonts/Inter-3.19.var.woff2 rel=preload type=font/woff2 as=font crossorigin=""><script async defer src="/js/min.js?hash=8db32dcb3a"></script><script async defer src="/js/cached.js?hash=29681a444d"></script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary: #f9c412;--primary-dark: #e7bf60;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{position:fixed;padding:.375em 1.5em;background:rgba(255,255,255,.9);font-weight:200;text-align:right}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px}share-widget div{width:30px;height:30px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center}.apple share-widget div{background-image:url(/img/share-apple.svg)}body,share-widget button{margin:0}share-widget button:active{transform:scale(1.2)}dialog{background-color:#8dff80;z-index:1000}header aside{font-style:italic}#nav{z-index:2;position:relative}#reading-progress,header nav{z-index:1;width:100vw;left:0;top:0}#reading-progress{background-color:var(--primary);position:absolute;bottom:0;transform:translate(-100vw,0);will-change:transform;pointer-events:none}@font-face{font-display:optional;font-family:"Inter UI";font-weight:100 900;font-style:oblique 0deg 10deg;src:url(/fonts/Inter-3.19.var.woff2) format("woff2")}html{line-height:1.15;-webkit-text-size-adjust:100%;font-family:Inter UI,sans-serif;--font-family: Inter UI, sans-serif}h1{font-size:3em;line-height:1.25;margin:.67em 0 .5em;font-size:2.074rem}a{background-color:transparent;color:#f9c412;text-decoration:none;color:var(--primary)}b{font-weight:700}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button,input{font-family:inherit;font-size:100%;line-height:1.15;overflow:visible}button{text-transform:none}input{margin:0}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em}h1,h2,h4{margin-bottom:1.36rem}h4{font-size:1.5em;margin-bottom:1em;line-height:1.5em;line-height:1.6rem;font-size:1.2rem}body,p,pre,ul{font-size:1em}p,pre,ul{margin-bottom:1.5em}h1,h2{line-height:2.4rem}h2{font-size:1.728rem}body,p,pre,ul{font-size:1rem;line-height:1.6}p,pre,ul{margin-bottom:1.36rem}@media (min-width:600px){h1{font-size:4.3978rem;line-height:4.4rem}h2{font-size:3.1097rem;line-height:3.52rem}h4{font-size:1.5554rem;line-height:1.76rem}body,p,pre,ul{font-size:1.1rem;line-height:1.6}h1,h2,h4,p,pre,ul{margin-bottom:1.496rem}}@media (min-width:1200px){h1{font-size:6.0756rem;line-height:6.72rem}h2{font-size:4.05rem;line-height:4.8rem}h4{font-size:1.8rem;line-height:1.92rem}body,p,pre,ul{font-size:1.2rem;line-height:1.6}h1,h2,h4,p,pre,ul{margin-bottom:1.632rem}}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre:has(code:not([class])){background:#2d2d2d}pre code:not([class]){color:#ccc;padding:0;overflow-x:scroll}code{border-radius:.3em;color:#e2777a;padding:0 .3em;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%;background:#2d2d2d}h1,h2,h4{font-family:var(--font-family)}h2,h4{font-style:italic}a:hover{text-decoration:underline}dt{font-weight:600;padding-top:.75em;padding-left:.75em}button,input{border-radius:.3em;max-width:100%}input{padding:.75em;margin-bottom:1.5em;display:inline}button+label,input+label,label+*{page-break-before:always}button,label{display:inline-block}button{background:#f2f2f2;color:#191919;cursor:pointer;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}input[type=datetime],input[type=file],input[type=number],input[type=text],input[type=time],input[type=url]{border:1px solid #595959;padding:.75em}*{border:0;box-sizing:border-box}body,header nav a{font-family:var(--font-family)}body{background:#181818;color:#eee}header label{display:block}header{padding:4.5em 1.5em 3em;width:37.5em;margin:0 auto;text-align:center;max-width:100%;display:flex;align-items:center;flex-direction:column}header p,ul{margin-top:0}header nav h1{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav a{font-weight:700;text-decoration:none;color:#181818;margin-left:1.5em}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}header nav label{color:#000;cursor:pointer;margin:0;font-style:normal;text-align:right}main{max-width:70rem;margin:0 auto;border-top:.5px solid #ccc}footer{background:rgba(0,0,0,.8);color:#fff;padding:3em;text-align:center}footer>*{margin:1.5em}footer nav a img{vertical-align:middle}footer nav,footer p{font-size:90%}article{max-width:100%;padding:1.5em;width:37.5em;margin:0 auto}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]{padding:0}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.comment{color:#999}.token.punctuation{color:#ccc}.token.tag{color:#e2777a}.token.number{color:#f08d49}.token.property{color:#f8c555}.token.builtin{color:#cc99cd}.token.string,.token.variable{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.token.inserted{color:green}</style><header><nav><div id=nav><h1><a href=/ title=Homepage>Re Alvarez Parmar's Blog</a></h1><a href=/about/ >About</a></div><div id=reading-progress aria-hidden=true></div></nav><aside>6 min read.</aside><dialog id=message></dialog><noscript><img alt="" height=1 src="/api/ga?v=1&_v=j83&t=pageview&dr=https%3A%2F%2Fno-script.com&_s=1&dh=realvarez.com&dp=%2Fposts%2Fscale-eks-mng-to-zero%2F&ul=en-us&de=UTF-8&dt=Reduce%20Amazon%20EKS%20cost%20by%20scaling%20node%20groups%20to%20zero&tid=G-B5XRB3YVTR" style=display:none width=1></noscript></header><main><article><p>Amazon EKS just released the support for <a href=https://aws.amazon.com/blogs/containers/amazon-eks-now-supports-kubernetes-version-1-24/ >Kubernetes version 1.24</a>. The new version supports a bunch of cool features. My favorite feature in this release is the ability to scale EKS managed node groups to (and from) zero.<p>Many customers I engage with have workloads that don’t run continuously. A good example is building software. Software build jobs run when new development teams push new code. Outside of business hours, the supporting infrastructure (like nodes) sits idle. Customers use autoscaling to scale down node groups, but managed node groups required a minimum of 1 node in a node group previously. That’s one node too many, especially when you need beefier and costly nodes with GPUs.<p>Scaling down to zero results in significant cost savings in such cases. In my opinion, you wouldn’t want to scale your entire cluster to zero. After all, you’d need some nodes to run Cluster Autoscaler and other shared services like Prometheus, AWS Load Balancer, CoreDNS, etc. You can use EKS on Fargate to run some of these services. But keep in mind that Prometheus requires a block storage, and AWS Fargate doesn’t support Amazon EBS yet.<p>You’d want to run a managed node group for your shared services, like Cluster Autoscaler, that run continuously. You can then add another node group for workloads that spawn periodically, and scale that node group to zero.<p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/Z2rpDlC-1920w.avif 1920w, /img/remote/Z2rpDlC-1280w.avif 1280w, /img/remote/Z2rpDlC-640w.avif 640w, /img/remote/Z2rpDlC-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/Z2rpDlC-1920w.webp 1920w, /img/remote/Z2rpDlC-1280w.webp 1280w, /img/remote/Z2rpDlC-640w.webp 640w, /img/remote/Z2rpDlC-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/Z2rpDlC-1920w.png 1920w, /img/remote/Z2rpDlC-1280w.png 1280w, /img/remote/Z2rpDlC-640w.png 640w, /img/remote/Z2rpDlC-320w.png 320w" type=image/png><img alt="Untitled Diagram.drawio.png" height=411 src=/img/remote/Z2rpDlC-1920w.png style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 471 411'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAHCAYAAAA1WQxeAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAvklEQVQImRXOzW6CQBhG4bn/2+h1dNOYNGnjxhhpYgGLEmUAgZlBmPl+3obleVbHxGVmfhYSyw9Z21xSXwoPF6HxKswkRtIsVO8Rvt7gik+Ev2/I4wDtMgAKE16rvB89flvVTbI66u40qh1eSkRqGtvJ6Vzh51wqCdAMC/ZZjeLWIQQP09hWtsgrq8SK3guyO5DXI7ybYJwPcrk7VHbWJRJ6zzjeCNd2BqUI432Qh+3RdE+dJoeYGGEVJN6WgH+1LtMmE1xLYAAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)" width=471 decoding=async loading=lazy></picture><h2 id=cluster-autoscaler-managed-node-group-cache>Cluster Autoscaler Managed Node group cache <a href=#cluster-autoscaler-managed-node-group-cache class=direct-link>#</a></h2><p>The Kubernetes Cluster Autoscaler project added support for scaling node groups to and from zero in version 0.6.1. However, it only worked if you added <a href=https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#how-can-i-scale-a-node-group-to-0>specific tags</a> to Auto Scaling groups. In other words, after creating a managed node group, you had to find out the associated Auto Scaling group and add Cluster Autoscaler tags yourself.<p>Starting Kubernetes version 1.24, you can create node groups (or tag existing node groups) with Cluster Autoscaler tags and Cluster Autoscaler will scale that node group to and from zero.<p>To enable scaling to and from zero, the awesome EKS team contributed a feature to the upstream Cluster Autoscaler project. The new feature adds a manage node group cache that holds labels and taints associated with managed node groups. Cluster Autoscaler now uses the EKS <a href=https://docs.aws.amazon.com/eks/latest/APIReference/API_DescribeNodegroup.html><code>DescribeNodegroup</code></a> API to determine a node's label and taints when there are no nodes in the node group. This allows scaling to and from zero and doesn't require adding Auto Scaling group tags.<h2 id=cluster-autoscaler-tags-for-scaling-to-zero>Cluster Autoscaler tags for scaling to zero <a href=#cluster-autoscaler-tags-for-scaling-to-zero class=direct-link>#</a></h2><p>Before you can start scaling a managed node group to and from zero, you’d need to <a href=https://docs.aws.amazon.com/eks/latest/userguide/autoscaling.html>add a few tags</a> to your node group. The tags you attach to your node group will help Cluster Autoscaler determine which node group to scale when a Pod is pending. You can add tags that help Cluster Autoscaler taints, labels, and node group’s resources like <code>WindowsENI</code>, <code>PrivateIPv4Address</code>, etc.<p>Labels and taints will tell the Kubernetes scheduler to assign Pods to specific nodes. When those Pods don’t have a node to run on (which will be the case when the node group is scaled to zero), Cluster Autoscaler can determine which node group to scale based on the tags. Let’s explore it using an example.<h2 id=scaling-a-managed-node-group-from-zero>Scaling a managed node group from zero <a href=#scaling-a-managed-node-group-from-zero class=direct-link>#</a></h2><p>You’d need a Kubernetes version 1.24 cluster to follow along. My EKS cluster already has node group, and I have <a href=https://docs.aws.amazon.com/eks/latest/userguide/autoscaling.html>installed Cluster Autoscaler</a> using EKS documentation.<p>Cluster Autoscaler needs the permissions to call the EKS <code>DescribeNodegroup</code> API to be able to read a node group's tags. The instructions in EKS documentation currently do not add <code>DescribeNodegroup</code> permissions to the Cluster Autoscaler IAM role.<p>The first thing you’d need to do is create an IAM policy that allows the Cluster Autoscaler IAM role to use <code>DescribeNodegroup</code> API.<p>Create a policy to allow EKS <code>DescribeNodegroup</code> API:<pre class=language-python><code class=language-python>cat <span class="token operator">></span> describe<span class="token operator">-</span>nodegroup<span class="token punctuation">.</span>json <span class="token operator">&lt;&lt;</span> EOF<br><span class="token punctuation">{</span><br>    <span class="token string">"Version"</span><span class="token punctuation">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span><br>    <span class="token string">"Statement"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><br>        <span class="token punctuation">{</span><br>            <span class="token string">"Action"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><br>                <span class="token string">"eks:DescribeNodegroup"</span><br>            <span class="token punctuation">]</span><span class="token punctuation">,</span><br>            <span class="token string">"Effect"</span><span class="token punctuation">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span><br>            <span class="token string">"Resource"</span><span class="token punctuation">:</span> <span class="token string">"*"</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">]</span><br><span class="token punctuation">}</span><br>EOF</code></pre><p>Now you need to add this policy to the Cluster Autoscaler IAM Role. Determine the name of the IAM Role attached to the Cluster Autoscaler service account:<pre class=language-python><code class=language-python>CA_IAM_ROLE<span class="token operator">=</span>$<span class="token punctuation">(</span>kubectl <span class="token operator">-</span>n kube<span class="token operator">-</span>system get  sa cluster<span class="token operator">-</span>autoscaler <span class="token operator">-</span>o  jsonpath<span class="token operator">=</span><span class="token string">'{.metadata.annotations.eks\.amazonaws\.com/role-arn}'</span> <span class="token operator">|</span> sed <span class="token string">'s|.*/||'</span> <span class="token punctuation">)</span></code></pre><p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/Zesv4v-1920w.avif 1920w, /img/remote/Zesv4v-1280w.avif 1280w, /img/remote/Zesv4v-640w.avif 640w, /img/remote/Zesv4v-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/Zesv4v-1920w.webp 1920w, /img/remote/Zesv4v-1280w.webp 1280w, /img/remote/Zesv4v-640w.webp 640w, /img/remote/Zesv4v-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/Zesv4v-1920w.png 1920w, /img/remote/Zesv4v-1280w.png 1280w, /img/remote/Zesv4v-640w.png 640w, /img/remote/Zesv4v-320w.png 320w" type=image/png><img alt=Image.png height=428 src=/img/remote/Zesv4v-1920w.png style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2542 428'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAADCAYAAABxhjRXAAAACXBIWXMAABYlAAAWJQFJUiTwAAAArElEQVQImWXDTW6CQBiAYW5QFZRR0NKFMWkbQGT4hpmRH7UxLnoD73+N14120yd5gsT/EMuAkp7s9Mv77U4ilqTxJPrISh9RtUcdHMvaMS8NUSl/56UQ5pqN6QiU7okKy2Lv2HZXMtOT2QtrM5LKwOyzYrIriCtPvHeo6rl+9cSV5cOdCRZmJKo7ls3I2l5I2zOpObHSA2FhmX4Lb18N07wlLP6PypZZLqQy8gBXE1ckRlswMwAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)" width=2542 decoding=async loading=lazy></picture><p>Then, add the policy you created to the IAM role that Cluster Autoscaler uses:<pre class=language-python><code class=language-python>aws iam put<span class="token operator">-</span>role<span class="token operator">-</span>policy <span class="token operator">-</span><span class="token operator">-</span>role<span class="token operator">-</span>name $CA_IAM_ROLE \<br>  <span class="token operator">-</span><span class="token operator">-</span>policy<span class="token operator">-</span>name EKSDescribeNodegroup \<br>  <span class="token operator">-</span><span class="token operator">-</span>policy<span class="token operator">-</span>document <span class="token builtin">file</span><span class="token punctuation">:</span><span class="token operator">//</span>describe<span class="token operator">-</span>nodegroup<span class="token punctuation">.</span>json</code></pre><p>Now you can start creating a new node group that you can set to scale to and from zero. Find out the role attached to an existing node group in your cluster. You can use AWS CLI to query that information.<pre class=language-python><code class=language-python><span class="token comment"># Store your EKS cluster name in an environment variable</span><br>EKS_CLUSTER<span class="token operator">=</span><span class="token operator">&lt;</span>YOUR CLUSTER NAME<span class="token operator">></span><br>AWS_ACCOUNT<span class="token operator">=</span>$<span class="token punctuation">(</span>aws sts get<span class="token operator">-</span>caller<span class="token operator">-</span>identity <span class="token operator">-</span><span class="token operator">-</span>query <span class="token string">'Account'</span> <span class="token operator">-</span><span class="token operator">-</span>output text<span class="token punctuation">)</span><br><br>NODE_ROLE<span class="token operator">=</span>$<span class="token punctuation">(</span>aws eks describe<span class="token operator">-</span>nodegroup \<br>  <span class="token operator">-</span><span class="token operator">-</span>cluster<span class="token operator">-</span>name $EKS_CLUSTER \<br>  <span class="token operator">-</span><span class="token operator">-</span>nodegroup<span class="token operator">-</span>name <span class="token operator">&lt;</span>YOUR NODE GROUP NAME<span class="token operator">></span> \<br>  <span class="token operator">-</span><span class="token operator">-</span>query <span class="token string">'nodegroup.nodeRole'</span> \<br>  <span class="token operator">-</span><span class="token operator">-</span>output text<span class="token punctuation">)</span></code></pre><p>You’d also need to provide the subnets for the new node group. You can use <code>describe-nodegroup</code> to find out the subnets attached to an existing node group.<p>Create a node group with a label that you will later use to assign Pods to nodes in this node group:<pre class=language-python><code class=language-python>aws eks create<span class="token operator">-</span>nodegroup \<br> <span class="token operator">-</span><span class="token operator">-</span>cli<span class="token operator">-</span><span class="token builtin">input</span><span class="token operator">-</span>json '<br><span class="token punctuation">{</span><br>  <span class="token string">"clusterName"</span><span class="token punctuation">:</span> <span class="token string">"${EKS_CLUSTER}"</span><span class="token punctuation">,</span><br>  <span class="token string">"nodegroupName"</span><span class="token punctuation">:</span> <span class="token string">"scale-to-zero"</span><span class="token punctuation">,</span><br>  <span class="token string">"scalingConfig"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><br>     <span class="token string">"minSize"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span><br>     <span class="token string">"maxSize"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span><br>     <span class="token string">"desiredSize"</span><span class="token punctuation">:</span> <span class="token number">0</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token string">"subnets"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><br>     <span class="token string">"&lt;subnet-ID1>"</span><span class="token punctuation">,</span><br>     <span class="token string">"&lt;subnet-ID2>"</span><span class="token punctuation">,</span><br>     <span class="token string">"&lt;subnet-ID3>"</span><br>   <span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token string">"nodeRole"</span><span class="token punctuation">:</span> <span class="token string">"${NODE_ROLE}"</span><span class="token punctuation">,</span><br>  <span class="token string">"labels"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><br>     <span class="token string">"app"</span><span class="token punctuation">:</span> <span class="token string">"frontend"</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token string">"tags"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><br>     <span class="token string">"k8s.io/cluster-autoscaler/node-template/label/app"</span><span class="token punctuation">:</span> <span class="token string">"frontend"</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span>'</code></pre><p><em>Replace the subnet IDs to match your environment.</em><p>Note that I added a tag <code>k8s.io/cluster-autoscaler/node-template/label/app</code> with value <code>frontend</code>. This is the same as running <code>kubectl label nodes &lt;YOUR NODE NAME> app=frontend</code>. When a node gets created in this node group, it will already have label <code>app=frontend</code>.<p>Now that the node group is created, let’s create a pod with a nodeSelector:<pre class=language-python><code class=language-python>cat <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">|</span> kubectl <span class="token builtin">apply</span> <span class="token operator">-</span>f <span class="token operator">-</span><br>apiVersion<span class="token punctuation">:</span> v1<br>kind<span class="token punctuation">:</span> Pod<br>metadata<span class="token punctuation">:</span><br>  name<span class="token punctuation">:</span> nginx<span class="token operator">-</span>test<br>spec<span class="token punctuation">:</span><br>  containers<span class="token punctuation">:</span><br>  <span class="token operator">-</span> name<span class="token punctuation">:</span> nginx<br>    image<span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>latest<br>  nodeSelector<span class="token punctuation">:</span><br>    app<span class="token punctuation">:</span> frontend<br>EOF</code></pre><p>The pod will remain pending for a few minutes. In my case, the pod was in pending state for five minutes.<p>In the meantime, you can see Cluster Autoscaler logs:<p><code>kubectl -n kube-system logs -f deployment.apps/cluster-autoscaler | grep scale-to-zero</code><p>Once Cluster Autoscaler adds a new node, the pod will start running. You can enable <a href=https://aws.amazon.com/blogs/containers/automatically-enable-group-metrics-collection-for-amazon-eks-managed-node-groups/ >Auto Scaling group metrics collection</a> to see how your node group scales.<p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/Z1GzCpp-1920w.avif 1920w, /img/remote/Z1GzCpp-1280w.avif 1280w, /img/remote/Z1GzCpp-640w.avif 640w, /img/remote/Z1GzCpp-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/Z1GzCpp-1920w.webp 1920w, /img/remote/Z1GzCpp-1280w.webp 1280w, /img/remote/Z1GzCpp-640w.webp 640w, /img/remote/Z1GzCpp-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/Z1GzCpp-1920w.jpg 1920w, /img/remote/Z1GzCpp-1280w.jpg 1280w, /img/remote/Z1GzCpp-640w.jpg 640w, /img/remote/Z1GzCpp-320w.jpg 320w" type=image/jpeg><img alt=Image.jpeg height=1238 src=/img/remote/Z1GzCpp-1920w.jpg style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2104 1238'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAIAAAB1kpiRAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAZElEQVQImT2MSQ7DMAwD/f/XNk6hzSQdRC46FxIUNMPdM7Oq3L3WMrP7/nrENefnmoOkGoCgQBYgaYGLes+g2KgT/YBehjeZaWZZGZluBsDMPGJI2nsf/ym7AfWXv2L8CtFx5A/5FrCidlfwXAAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)" width=2104 decoding=async loading=lazy></picture><p>Great! Cluster Autoscaler saw that the test pod was pending, so it scaled the node group from 0.<p>Now let’s delete the test pod and verify that the node group goes back to 0:<pre class=language-python><code class=language-python>kubectl delete pods nginx<span class="token operator">-</span>test</code></pre><p>Cluster Autoscaler will notice that the node with app=frontend is not running any pods and scale down the node group (after the cooldown period).<p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/ZBdwQq-1920w.avif 1920w, /img/remote/ZBdwQq-1280w.avif 1280w, /img/remote/ZBdwQq-640w.avif 640w, /img/remote/ZBdwQq-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/ZBdwQq-1920w.webp 1920w, /img/remote/ZBdwQq-1280w.webp 1280w, /img/remote/ZBdwQq-640w.webp 640w, /img/remote/ZBdwQq-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/ZBdwQq-1920w.jpg 1920w, /img/remote/ZBdwQq-1280w.jpg 1280w, /img/remote/ZBdwQq-640w.jpg 640w, /img/remote/ZBdwQq-320w.jpg 320w" type=image/jpeg><img alt=Image.jpeg height=1298 src=/img/remote/ZBdwQq-1920w.jpg style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2094 1298'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAIAAAB1kpiRAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAaUlEQVQImSXM2wrAMAwC0P7/z66j0FzUdKSTPIiEM9w9IgC6e2buvddaZjbn+8x3AKgqSQBJkfQEpQQTGuecqlNVt3SkorpQGmb2s2YWN+5O8u7RuCSq2S4k2GwkPDkkXan0nwQp+7PxD+uCsGkJPTrHAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)" width=2094 decoding=async loading=lazy></picture><p>Perfect, the node group is back to having 0 nodes.<h2 id=conclusion>Conclusion <a href=#conclusion class=direct-link>#</a></h2><p>Scaling down to zero can result in significant cost savings when you have workloads that don’t run 24x7. With Kubernetes 1.24, all you need to do is tag your node groups with labels, taints, or resources, and Cluster Autoscaler will scale your nodes to and from zero.<p>Happy scaling!</p><share-widget><button aria-label=Share href=https://blog.realvarez.com/posts/scale-eks-mng-to-zero/ on-click=share><div></div></button></share-widget><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","headline":"Reduce Amazon EKS cost by scaling node groups to zero","image":["https://blog.realvarez.com/img/remote/Z2rpDlC-1920w.png","https://blog.realvarez.com/img/remote/Zesv4v-1920w.png","https://blog.realvarez.com/img/remote/Z1GzCpp-1920w.jpg","https://blog.realvarez.com/img/remote/ZBdwQq-1920w.jpg"],"author":"","genre":"Insert a schema.org genre","publisher":{"@type":"Organization","name":"","logo":{"@type":"ImageObject","url":"/img/favicon/favicon-192x192.png?hash=ae2c3e88f6"}},"url":"https://blog.realvarez.com/posts/scale-eks-mng-to-zero/","mainEntityOfPage":"https://blog.realvarez.com/posts/scale-eks-mng-to-zero/","datePublished":"2022-11-16","dateModified":"2023-04-09","description":"Amazon EKS just released the support for Kubernetes version 1.24. The new version supports a bunch of cool features. My favorite feature in..."}</script><p>Published <time datetime=2022-11-16>16 Nov 2022</time></article></main><footer><a href=/about/ ></a></footer>