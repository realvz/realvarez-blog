<!DOCTYPE html><html domain=realvarez.com ga-id=G-B5XRB3YVTR lang=en><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><link href="/img/favicon/favicon-192x192.png?hash=ae2c3e88f6" rel=icon type=image/png><meta content=#f9c412 name=theme-color><meta content="max-snippet:-1, max-image-preview: large, max-video-preview: -1" name=robots><title>Using eStargz to reduce container startup time on Amazon EKS</title><meta content="Using eStargz to reduce container startup time on Amazon EKS" property=og:title><meta content="This post explains how to use eStargz snapshotter with containerd" name=description><meta content="This post explains how to use eStargz snapshotter with containerd" property=og:description><meta content=summary_large_image name=twitter:card><meta content=@realz name=twitter:site><meta content=@realz name=twitter:creator><link href=https://blog.realvarez.com/posts/estargz/ rel=canonical><meta content=no-referrer-when-downgrade name=referrer><link href=/feed/feed.xml rel=alternate type=application/atom+xml title="Re Alvarez Parmar's Blog"><link href=/ rel=preconnect crossorigin=""><link href=/fonts/Inter-3.19.var.woff2 rel=preload type=font/woff2 as=font crossorigin=""><script async defer src="/js/min.js?hash=8db32dcb3a"></script><script async defer src="/js/cached.js?hash=29681a444d"></script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary: #f9c412;--primary-dark: #e7bf60;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{position:fixed;padding:.375em 1.5em;background:rgba(255,255,255,.9);font-weight:200;text-align:right}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px}share-widget div{width:30px;height:30px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center}.apple share-widget div{background-image:url(/img/share-apple.svg)}body,share-widget button{margin:0}share-widget button:active{transform:scale(1.2)}dialog{background-color:#8dff80;z-index:1000}header aside{font-style:italic}#nav{z-index:2;position:relative}#reading-progress,header nav{z-index:1;width:100vw;left:0;top:0}#reading-progress{background-color:var(--primary);position:absolute;bottom:0;transform:translate(-100vw,0);will-change:transform;pointer-events:none}@font-face{font-display:optional;font-family:"Inter UI";font-weight:100 900;font-style:oblique 0deg 10deg;src:url(/fonts/Inter-3.19.var.woff2) format("woff2")}button,html{line-height:1.15}html{-webkit-text-size-adjust:100%;font-family:Inter UI,sans-serif;--font-family: Inter UI, sans-serif}h1{font-size:3em;line-height:1.25;margin:.67em 0 .5em;font-size:2.074rem}a{background-color:transparent;color:#f9c412;text-decoration:none;color:var(--primary)}b,strong{font-weight:700}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button{font-family:inherit;font-size:100%;overflow:visible;text-transform:none}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em}h1,h2,h4{margin-bottom:1.36rem}h4{font-size:1.5em;margin-bottom:1em;line-height:1.5em;line-height:1.6rem;font-size:1.2rem}body,p,pre,ul{font-size:1em}p,pre,ul{margin-bottom:1.5em}h1,h2{line-height:2.4rem}h2{font-size:1.728rem}body,p,pre,ul{font-size:1rem;line-height:1.6}p,pre,ul{margin-bottom:1.36rem}@media (min-width:600px){h1{font-size:4.3978rem;line-height:4.4rem}h2{font-size:3.1097rem;line-height:3.52rem}h4{font-size:1.5554rem;line-height:1.76rem}body,p,pre,ul{font-size:1.1rem;line-height:1.6}h1,h2,h4,p,pre,ul{margin-bottom:1.496rem}}@media (min-width:1200px){h1{font-size:6.0756rem;line-height:6.72rem}h2{font-size:4.05rem;line-height:4.8rem}h4{font-size:1.8rem;line-height:1.92rem}body,p,pre,ul{font-size:1.2rem;line-height:1.6}h1,h2,h4,p,pre,ul{margin-bottom:1.632rem}}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre:has(code:not([class])){background:#2d2d2d}pre code:not([class]){color:#ccc;padding:0;overflow-x:scroll}button,code{border-radius:.3em}code{color:#e2777a;padding:0 .3em;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%;background:#2d2d2d}h1,h2,h4{font-family:var(--font-family)}h2,h4{font-style:italic}a:hover{text-decoration:underline}dt{font-weight:600;padding-top:.75em;padding-left:.75em}button{max-width:100%;background:#f2f2f2;color:#191919;cursor:pointer;display:inline-block;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}*{border:0;box-sizing:border-box}body,header nav a{font-family:var(--font-family)}body{background:#181818;color:#eee}header{padding:4.5em 1.5em 3em;width:37.5em;margin:0 auto;text-align:center;max-width:100%;display:flex;align-items:center;flex-direction:column}header p,ul{margin-top:0}header nav h1{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav a{font-weight:700;text-decoration:none;color:#181818;margin-left:1.5em}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}main{max-width:70rem;margin:0 auto;border-top:.5px solid #ccc}footer{background:rgba(0,0,0,.8);color:#fff;padding:3em;text-align:center}footer>*{margin:1.5em}footer nav a img{vertical-align:middle}footer nav,footer p{font-size:90%}article{max-width:100%;padding:1.5em;width:37.5em;margin:0 auto}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]{padding:0}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.comment{color:#999}.token.punctuation{color:#ccc}.token.number{color:#f08d49}.token.property{color:#f8c555}.token.builtin,.token.keyword{color:#cc99cd}.token.string{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.token.inserted{color:green}</style><header><nav><div id=nav><h1><a href=/ title=Homepage>Re Alvarez Parmar's Blog</a></h1><a href=/about/ >About</a></div><div id=reading-progress aria-hidden=true></div></nav><aside>8 min read.</aside><dialog id=message></dialog><noscript><img alt="" height=1 src="/api/ga?v=1&_v=j83&t=pageview&dr=https%3A%2F%2Fno-script.com&_s=1&dh=realvarez.com&dp=%2Fposts%2Festargz%2F&ul=en-us&de=UTF-8&dt=Using%20eStargz%20to%20reduce%20container%20startup%20time%20on%20Amazon%20EKS&tid=G-B5XRB3YVTR" style=display:none width=1></noscript></header><main><article><p>A container image bundles executable code, library, and configuration. Images contain everything an application needs to run. It is a best practice to exclude any file that’s unnecessary for the application packaged in the image. A smaller image means that when you create a container, the container runtime (dockerd or containerd) will have to download fewer bits from the container registry, which will result in faster startup time.<p>There are cases when the container image becomes significantly large (>500 MB). A common scenario is machine learning workloads. ML workload containers usually package model data necessary for the application. The image size for these containers can easily span in to multiple GBs. As a result, these applications have a slower startup time when the runtime has to pull the image. In fact, <a href=https://www.usenix.org/conference/fast16/technical-sessions/presentation/harter>research</a> shows that pulling packages accounts for 76% of container start time, but only 6.4% of that data is read.<h2 id=lazy-pulling>Lazy-pulling <a href=#lazy-pulling class=direct-link>#</a></h2><p>There are two open source projects designed to improve container startup time. <a href=https://github.com/containerd/stargz-snapshotter>Stargz</a> and <a href=https://github.com/awslabs/soci-snapshotter>SOCI</a> are containerd plugins that reduce the cold start time by providing a way to run containers without downloading the entire image. They introduce the concept of <em>lazy pulling</em>, a technique that allows the runtime to download the bits from the container registry as needed.<p>Using lazy pulling significantly reduces the application startup time. eStargz is a lazily-pullable image format that is compatible with <a href=https://github.com/opencontainers/runtime-spec>OCI runtimes</a> and standard container registries like DockerHub, GitHub Container Registry.<h2 id=estargz>eStargz <a href=#estargz class=direct-link>#</a></h2><p>The eStargz image format is based on stargz image format by Container Registry Filesystem (CRFS) open source project. <strong>CRFS</strong> is a read-only FUSE filesystem that lets you mount a container image, served directly from a container registry, without pulling it all locally first. The project introduces <strong>S</strong>eekable tar.gz format, which makes tar.gz files seekable using an index.<h2 id=stargz-snapshotter-plugin>Stargz Snapshotter plugin <a href=#stargz-snapshotter-plugin class=direct-link>#</a></h2><p>Stargz snapshotter is implemented as a <a href=https://github.com/containerd/containerd/blob/04985039cede6aafbb7dfb3206c9c4d04e2f924d/PLUGINS.md#proxy-plugins>proxy plugin</a> daemon (<code>containerd-stargz-grpc</code>) for containerd. When containerd starts a container, it queries the rootfs snapshots to stargz snapshotter daemon through a unix socket. This snapshotter remotely mounts queried eStargz layers from registries on the node and provides these mount points as remote snapshots to containerd. The plugin uses FUSE to mount eStargz layers directly from the container registry.<p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/WQYt4-1920w.avif 1920w, /img/remote/WQYt4-1280w.avif 1280w, /img/remote/WQYt4-640w.avif 640w, /img/remote/WQYt4-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/WQYt4-1920w.webp 1920w, /img/remote/WQYt4-1280w.webp 1280w, /img/remote/WQYt4-640w.webp 640w, /img/remote/WQYt4-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/WQYt4-1920w.jpg 1920w, /img/remote/WQYt4-1280w.jpg 1280w, /img/remote/WQYt4-640w.jpg 640w, /img/remote/WQYt4-320w.jpg 320w" type=image/jpeg><img alt=Image.tiff height=644 src=/img/remote/WQYt4-1920w.jpg style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1566 644'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAFCAYAAABxeg0vAAAACXBIWXMAAAPoAAAD6AG1e1JrAAAAzUlEQVQImR3OwUrDQBRA0XyiP+IHuejKhSi6EEF3QnFRLAQr0oURC6VJO02TZt6bppmZRK60y7u4cBIRQcXhRHHisI1yDJE/oO8HYgioKjFGhmEgOUW/eqWdP9LNb/Empa0NfpkSfIcPPUWR470/T4lzjlk2JptcM0sfyL6eCXeXyNUF8jbCyR4Rpa4rQggkJ9JyH1iVlsXuiKksh98p8n5D8/FE8/mCLX7Y7iqcKknbtph1Tllu2RQ5ZrM++6OW1NN7yvGI+nuCPXSoCv/eZN12jtAyEwAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)" width=1566 decoding=async loading=lazy></picture><h2 id=running-estargz-images-on-amazon-eks>Running eStargz images on Amazon EKS <a href=#running-estargz-images-on-amazon-eks class=direct-link>#</a></h2><p>eStargz images are a little different from the images you’d build using <code>docker build</code>. In order to create an image that supports lazy pulling, you'll need an eStargz-aware image builder or a converter.<p>I am going to build my eStargz image using nerdctl, which is an eStargz-aware image builder. Since image size is not an issue, I will use Debian Jessie as the base image to demo. To make the image size artificially large, I will include twenty 50 MB files.<p>Lets generate large files containing random text:<pre class=language-python><code class=language-python>mkdir files<br><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">{</span><span class="token number">0.</span><span class="token number">.20</span><span class="token punctuation">}</span><span class="token punctuation">;</span> do base64 <span class="token operator">/</span>dev<span class="token operator">/</span>urandom <span class="token operator">|</span> head <span class="token operator">-</span>c <span class="token number">50000000</span> <span class="token operator">></span> files<span class="token operator">/</span><span class="token builtin">file</span>$<span class="token punctuation">{</span>i<span class="token punctuation">}</span><span class="token punctuation">.</span>txt<span class="token punctuation">;</span> done</code></pre><p>Create a DockerFile:<pre class=language-python><code class=language-python>cat <span class="token operator">></span> Dockerfile <span class="token operator">&lt;&lt;</span>EOF<br>FROM debian<span class="token punctuation">:</span>jessie<br>RUN apt<span class="token operator">-</span>get update <span class="token operator">&</span><span class="token operator">&</span> apt<span class="token operator">-</span>get install <span class="token operator">-</span>y \<br>    vim<br>COPY files <span class="token punctuation">.</span><br><br>EOF</code></pre><p>I am going to store my image in Amazon ECR. I’ll create an ECR repository:<pre class=language-python><code class=language-python>ECR_URI<span class="token operator">=</span>$<span class="token punctuation">(</span>aws ecr create<span class="token operator">-</span>repository \<br>  <span class="token operator">-</span><span class="token operator">-</span>repository<span class="token operator">-</span>name estargz<span class="token operator">-</span>demo \<br>  <span class="token operator">-</span><span class="token operator">-</span>query <span class="token string">'repository.repositoryUri'</span> \<br>  <span class="token operator">-</span><span class="token operator">-</span>output text<span class="token punctuation">)</span></code></pre><p>Use nerdctl to create container image:<pre class=language-python><code class=language-python>sudo nerdctl build <span class="token operator">-</span>t $<span class="token punctuation">{</span>ECR_URI<span class="token punctuation">}</span><span class="token punctuation">:</span><span class="token number">1</span> <span class="token punctuation">.</span></code></pre><p>The image is not in eStargz formatted right now, I’ll have to convert it:<pre class=language-python><code class=language-python>nerdctl image convert <span class="token operator">-</span><span class="token operator">-</span>estargz <span class="token operator">-</span><span class="token operator">-</span>oci \<br>  $<span class="token punctuation">{</span>ECR_URI<span class="token punctuation">}</span><span class="token punctuation">:</span><span class="token number">1</span> $<span class="token punctuation">{</span>ECR_URI<span class="token punctuation">}</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token operator">-</span>esgz</code></pre><p>The resulting images:<pre class=language-python><code class=language-python>nerdctl images<br>REPOSITORY                                                   TAG       IMAGE ID        CREATED           PLATFORM       SIZE       BLOB SIZE<br>account<span class="token punctuation">.</span>dkr<span class="token punctuation">.</span>ecr<span class="token punctuation">.</span>us<span class="token operator">-</span>west<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">.</span>amazonaws<span class="token punctuation">.</span>com<span class="token operator">/</span>estargz<span class="token operator">-</span>demo    <span class="token number">1</span>         798b85a131ed    <span class="token number">31</span> minutes ago    linux<span class="token operator">/</span>amd64    <span class="token number">1.2</span> GiB    <span class="token number">828.8</span> MiB<br>account<span class="token punctuation">.</span>dkr<span class="token punctuation">.</span>ecr<span class="token punctuation">.</span>us<span class="token operator">-</span>west<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">.</span>amazonaws<span class="token punctuation">.</span>com<span class="token operator">/</span>estargz<span class="token operator">-</span>demo    <span class="token number">1</span><span class="token operator">-</span>esgz    81b0ffd2a4a3    <span class="token number">36</span> seconds ago    linux<span class="token operator">/</span>amd64    <span class="token number">0.0</span> B      <span class="token number">832.3</span> MiB</code></pre><p>Login to ECR and push the image to ECR:<pre class=language-python><code class=language-python>aws ecr get<span class="token operator">-</span>login<span class="token operator">-</span>password <span class="token operator">|</span> sudo nerdctl login \<br>   <span class="token operator">-</span><span class="token operator">-</span>username AWS \<br>   <span class="token operator">-</span><span class="token operator">-</span>password<span class="token operator">-</span>stdin \<br>   $ECR_URI<br>nerdctl push $<span class="token punctuation">{</span>ECR_URI<span class="token punctuation">}</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token operator">-</span>esgz</code></pre><p>The image is now available in ECR and I can start running it in my EKS cluster.<h2 id=create-a-managed-node-group-that-uses-containerd>Create a managed node group that uses containerd <a href=#create-a-managed-node-group-that-uses-containerd class=direct-link>#</a></h2><p>EKS nodes currently don’t enable containerd by default. I’ll create a node group that uses containerd.<p>Create environment variables for AWS Region and EKS cluster name:<pre class=language-python><code class=language-python>AWS_REGION<span class="token operator">=</span><span class="token operator">&lt;</span>Your AWS Region<span class="token operator">></span><br>CLUSTER_NAME<span class="token operator">=</span><span class="token operator">&lt;</span>Your EKS cluster's name<span class="token operator">></span></code></pre><p>First, I need to retrieve the id of the EKS optimized AMI in my region:<pre class=language-python><code class=language-python>AMI_ID<span class="token operator">=</span>$<span class="token punctuation">(</span>aws ssm get<span class="token operator">-</span>parameter <span class="token operator">-</span><span class="token operator">-</span>name <span class="token operator">/</span>aws<span class="token operator">/</span>service<span class="token operator">/</span>eks<span class="token operator">/</span>optimized<span class="token operator">-</span>ami<span class="token operator">/</span><span class="token number">1.23</span><span class="token operator">/</span>amazon<span class="token operator">-</span>linux<span class="token operator">-</span><span class="token number">2</span><span class="token operator">/</span>recommended<span class="token operator">/</span>image_id <span class="token operator">-</span><span class="token operator">-</span>region us<span class="token operator">-</span>west<span class="token operator">-</span><span class="token number">2</span> <span class="token operator">-</span><span class="token operator">-</span>query <span class="token string">"Parameter.Value"</span> <span class="token operator">-</span><span class="token operator">-</span>output text<span class="token punctuation">)</span></code></pre><pre class=language-python><code class=language-python>cat <span class="token operator">></span> containerd<span class="token operator">-</span>mng<span class="token punctuation">.</span>yaml <span class="token operator">&lt;&lt;</span>EOF<br>apiVersion<span class="token punctuation">:</span> eksctl<span class="token punctuation">.</span>io<span class="token operator">/</span>v1alpha5<br>kind<span class="token punctuation">:</span> ClusterConfig<br><br>metadata<span class="token punctuation">:</span><br>  name<span class="token punctuation">:</span> $CLUSTER_NAME<br>  region<span class="token punctuation">:</span> $AWS_REGION<br><br>managedNodeGroups<span class="token punctuation">:</span><br>  <span class="token operator">-</span> name<span class="token punctuation">:</span> containerd<span class="token operator">-</span>mng<br>    minSize<span class="token punctuation">:</span> <span class="token number">1</span><br>    maxSize<span class="token punctuation">:</span> <span class="token number">1</span><br>    desiredCapacity<span class="token punctuation">:</span> <span class="token number">1</span><br>    instanceType<span class="token punctuation">:</span> m5<span class="token punctuation">.</span>xlarge<br>    ami<span class="token punctuation">:</span> $AMI_ID<br>    overrideBootstrapCommand<span class="token punctuation">:</span> <span class="token operator">|</span><br>      <span class="token comment">#!/bin/bash</span><br>      <span class="token operator">/</span>etc<span class="token operator">/</span>eks<span class="token operator">/</span>bootstrap<span class="token punctuation">.</span>sh Socrates <span class="token operator">-</span><span class="token operator">-</span>container<span class="token operator">-</span>runtime containerd<br>    <br>EOF</code></pre><h2 id=preparing-eks-nodes-to-use-estargz>Preparing EKS nodes to use eStargz <a href=#preparing-eks-nodes-to-use-estargz class=direct-link>#</a></h2><p>Next, I need to install eStargz snapshotter plugin on my worker node. I use AWS Systems Manager on my nodes, so I will connect to the containerd node.<pre class=language-python><code class=language-python>aws ssm start<span class="token operator">-</span>session <span class="token operator">-</span><span class="token operator">-</span>target <span class="token operator">&lt;</span>Instance ID of the worker node<span class="token operator">></span></code></pre><p>Connect to the node (using ssh or Systems Manager) and back up the current containerd config file (/etc/containerd/config.toml) and replace it with:<pre class=language-python><code class=language-python>sudo mv <span class="token operator">/</span>etc<span class="token operator">/</span>containerd<span class="token operator">/</span>config<span class="token punctuation">.</span>toml <span class="token operator">/</span>etc<span class="token operator">/</span>containerd<span class="token operator">/</span>config<span class="token punctuation">.</span>toml<span class="token punctuation">.</span>bak<br>cat <span class="token operator">></span> config<span class="token punctuation">.</span>toml <span class="token operator">&lt;&lt;</span>EOF<br>version <span class="token operator">=</span> <span class="token number">2</span><br>root <span class="token operator">=</span> <span class="token string">"/var/lib/containerd"</span><br>state <span class="token operator">=</span> <span class="token string">"/run/containerd"</span><br><br><span class="token punctuation">[</span>grpc<span class="token punctuation">]</span><br>address <span class="token operator">=</span> <span class="token string">"/run/containerd/containerd.sock"</span><br><br><span class="token punctuation">[</span>plugins<span class="token punctuation">.</span><span class="token string">"io.containerd.grpc.v1.cri"</span><span class="token punctuation">.</span>containerd<span class="token punctuation">]</span><br>default_runtime_name <span class="token operator">=</span> <span class="token string">"runc"</span><br>snapshotter <span class="token operator">=</span> <span class="token string">"stargz"</span><br>disable_snapshot_annotations <span class="token operator">=</span> false<br><br><span class="token punctuation">[</span>plugins<span class="token punctuation">.</span><span class="token string">"io.containerd.grpc.v1.cri"</span><span class="token punctuation">]</span><br>sandbox_image <span class="token operator">=</span> <span class="token string">"602401143452.dkr.ecr.us-west-2.amazonaws.com/eks/pause:3.5"</span><br><br><span class="token punctuation">[</span>plugins<span class="token punctuation">.</span><span class="token string">"io.containerd.grpc.v1.cri"</span><span class="token punctuation">.</span>containerd<span class="token punctuation">.</span>runtimes<span class="token punctuation">.</span>runc<span class="token punctuation">]</span><br>runtime_type <span class="token operator">=</span> <span class="token string">"io.containerd.runc.v2"</span><br><br><span class="token punctuation">[</span>plugins<span class="token punctuation">.</span><span class="token string">"io.containerd.grpc.v1.cri"</span><span class="token punctuation">.</span>containerd<span class="token punctuation">.</span>runtimes<span class="token punctuation">.</span>runc<span class="token punctuation">.</span>options<span class="token punctuation">]</span><br>SystemdCgroup <span class="token operator">=</span> true<br><br><span class="token punctuation">[</span>plugins<span class="token punctuation">.</span><span class="token string">"io.containerd.grpc.v1.cri"</span><span class="token punctuation">.</span>cni<span class="token punctuation">]</span><br>bin_dir <span class="token operator">=</span> <span class="token string">"/opt/cni/bin"</span><br>conf_dir <span class="token operator">=</span> <span class="token string">"/etc/cni/net.d"</span><br><br><span class="token punctuation">[</span>proxy_plugins<span class="token punctuation">]</span><br>  <span class="token punctuation">[</span>proxy_plugins<span class="token punctuation">.</span>stargz<span class="token punctuation">]</span><br>    <span class="token builtin">type</span> <span class="token operator">=</span> <span class="token string">"snapshot"</span><br>    address <span class="token operator">=</span> <span class="token string">"/run/containerd-stargz-grpc/containerd-stargz-grpc.sock"</span><br>EOF<br>sudo mv config<span class="token punctuation">.</span>toml <span class="token operator">/</span>etc<span class="token operator">/</span>containerd<span class="token operator">/</span>config<span class="token punctuation">.</span>toml</code></pre><p>Install FUSE:<pre class=language-python><code class=language-python>sudo yum install fuse <span class="token operator">-</span>y<br>sudo modprobe fuse<br>sudo bash <span class="token operator">-</span>c <span class="token string">'echo "fuse" > /etc/modules-load.d/fuse.conf'</span></code></pre><p>Install the snapshotter from its <a href=https://github.com/containerd/stargz-snapshotter/releases>GitHub</a> repository:<pre class=language-python><code class=language-python>wget https<span class="token punctuation">:</span><span class="token operator">//</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>containerd<span class="token operator">/</span>stargz<span class="token operator">-</span>snapshotter<span class="token operator">/</span>releases<span class="token operator">/</span>download<span class="token operator">/</span>v0<span class="token punctuation">.</span><span class="token number">12.1</span><span class="token operator">/</span>stargz<span class="token operator">-</span>snapshotter<span class="token operator">-</span>v0<span class="token punctuation">.</span><span class="token number">12.1</span><span class="token operator">-</span>linux<span class="token operator">-</span>amd64<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz<br>sudo tar xvzf stargz<span class="token operator">-</span>snapshotter<span class="token operator">-</span>v0<span class="token punctuation">.</span><span class="token number">12.1</span><span class="token operator">-</span>linux<span class="token operator">-</span>amd64<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz <span class="token operator">-</span>C <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span><span class="token builtin">bin</span><br>sudo wget <span class="token operator">-</span>O <span class="token operator">/</span>etc<span class="token operator">/</span>systemd<span class="token operator">/</span>system<span class="token operator">/</span>stargz<span class="token operator">-</span>snapshotter<span class="token punctuation">.</span>service https<span class="token punctuation">:</span><span class="token operator">//</span>raw<span class="token punctuation">.</span>githubusercontent<span class="token punctuation">.</span>com<span class="token operator">/</span>containerd<span class="token operator">/</span>stargz<span class="token operator">-</span>snapshotter<span class="token operator">/</span>main<span class="token operator">/</span>script<span class="token operator">/</span>config<span class="token operator">/</span>etc<span class="token operator">/</span>systemd<span class="token operator">/</span>system<span class="token operator">/</span>stargz<span class="token operator">-</span>snapshotter<span class="token punctuation">.</span>service<br>sudo systemctl enable <span class="token operator">-</span><span class="token operator">-</span>now stargz<span class="token operator">-</span>snapshotter</code></pre><p>Finally, restart the containerd and kubelet:<pre class=language-python><code class=language-python>sudo systemctl restart containerd<br>sudo systemctl restart kubelet</code></pre><h2 id=test-lazy-pulling>Test lazy-pulling <a href=#test-lazy-pulling class=direct-link>#</a></h2><p>I will now run the pod using my eStargz formatted image. Create a manifest for a new pod and replace the node name with the newly created node:<pre class=language-python><code class=language-python>cat <span class="token operator">></span> estargz<span class="token operator">-</span>pod<span class="token punctuation">.</span>yaml <span class="token operator">&lt;&lt;</span>EOF<br>apiVersion<span class="token punctuation">:</span> v1<br>kind<span class="token punctuation">:</span> Pod<br>metadata<span class="token punctuation">:</span><br>  name<span class="token punctuation">:</span> stargz<span class="token operator">-</span>demo<br>spec<span class="token punctuation">:</span><br>  containers<span class="token punctuation">:</span><br>  <span class="token operator">-</span> name<span class="token punctuation">:</span> stargz<span class="token operator">-</span>demo<br>    image<span class="token punctuation">:</span> $<span class="token punctuation">{</span>ECR_URI<span class="token punctuation">}</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token operator">-</span>esgz<br>    command<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"/bin/bash"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"--"</span> <span class="token punctuation">]</span><br>    args<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"while true; do sleep 30; done;"</span> <span class="token punctuation">]</span><br>  nodeName<span class="token punctuation">:</span> ip<span class="token operator">-</span><span class="token number">192</span><span class="token operator">-</span><span class="token number">168</span><span class="token operator">-</span><span class="token number">32</span><span class="token operator">-</span><span class="token number">236</span><span class="token punctuation">.</span>us<span class="token operator">-</span>west<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">.</span>compute<span class="token punctuation">.</span>internal<br>EOF</code></pre><p>The pod started in 2 seconds:<pre class=language-python><code class=language-python>k get pods<br>NAME                            READY   STATUS        RESTARTS      AGE<br>stargz<span class="token operator">-</span>demo                     <span class="token number">1</span><span class="token operator">/</span><span class="token number">1</span>     Running       <span class="token number">0</span>             2s</code></pre><p>To compare, I ran the same pod on another node that didn’t use containerd. It took 45 seconds to start the same image. That’s a lot of improvement in pod startup time!!<p>Image pull time <em>without</em> eStargz:<p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/1SDRNy-1920w.avif 1920w, /img/remote/1SDRNy-1280w.avif 1280w, /img/remote/1SDRNy-640w.avif 640w, /img/remote/1SDRNy-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/1SDRNy-1920w.webp 1920w, /img/remote/1SDRNy-1280w.webp 1280w, /img/remote/1SDRNy-640w.webp 640w, /img/remote/1SDRNy-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/1SDRNy-1920w.jpg 1920w, /img/remote/1SDRNy-1280w.jpg 1280w, /img/remote/1SDRNy-640w.jpg 640w, /img/remote/1SDRNy-320w.jpg 320w" type=image/jpeg><img alt=Image.jpeg height=248 src=/img/remote/1SDRNy-1920w.jpg style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2524 248'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAACCAIAAAAimuBsAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAfklEQVQImS3KWQ6CMABFUbYAGILSYhGBFWgVa0c6MXT/yzFQk5P38XITRB2kFlILiAHEVMRA6oq3Sh88xyJ78vSQHeITtxxVOaocyxOWxWuXtHK9co+Yb8Qc3eTSTdtdrb0O/RQGHTq9Ie4R/zetXPZMzDVzF2LOHw2+tmbuB+LFHwp1HIOKAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)" width=2524 decoding=async loading=lazy></picture><p>Image pull with eStargz:<p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/Zzj0qB-1920w.avif 1920w, /img/remote/Zzj0qB-1280w.avif 1280w, /img/remote/Zzj0qB-640w.avif 640w, /img/remote/Zzj0qB-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/Zzj0qB-1920w.webp 1920w, /img/remote/Zzj0qB-1280w.webp 1280w, /img/remote/Zzj0qB-640w.webp 640w, /img/remote/Zzj0qB-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/remote/Zzj0qB-1920w.jpg 1920w, /img/remote/Zzj0qB-1280w.jpg 1280w, /img/remote/Zzj0qB-640w.jpg 640w, /img/remote/Zzj0qB-320w.jpg 320w" type=image/jpeg><img alt=Image.jpeg height=218 src=/img/remote/Zzj0qB-1920w.jpg style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2534 218'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAABoAAAACCAIAAADJrVtvAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAdUlEQVQImV3MWw6DIBCFYdfQNG3AcluFVscZIHIZ9r+gBvSpyZ/zcB6+yVLRVDVWhUVh+RxZY3Whie2UkGbIYjv/knu6g/T+xscSn0t8rb3J0IAgd5SqGbT13JfY+mY9u9AMscJqaPyer1xoCouELPY0H134AeJpIHRqTrqyAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)" width=2534 decoding=async loading=lazy></picture><h2 id=prefetching-files>Prefetching files <a href=#prefetching-files class=direct-link>#</a></h2><p>What if you wanted the runtime to always download a file and disable lazy-pulling?<p>eStargz supports prefetching of files. This mitigates runtime performance drawbacks caused by the on-demand fetching of each file.<p>The example below always pulls <code>ls</code> and <code>bash</code> files before starting the container:<pre class=language-python><code class=language-python>$ cat <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">></span> <span class="token operator">/</span>tmp<span class="token operator">/</span>record<span class="token punctuation">.</span>json<br><span class="token punctuation">{</span> <span class="token string">"path"</span> <span class="token punctuation">:</span> <span class="token string">"/usr/bin/bash"</span> <span class="token punctuation">}</span><br><span class="token punctuation">{</span> <span class="token string">"path"</span> <span class="token punctuation">:</span> <span class="token string">"/usr/bin/ls"</span> <span class="token punctuation">}</span><br>EOF<br>$ nerdctl image convert <span class="token operator">-</span><span class="token operator">-</span>estargz <span class="token operator">-</span><span class="token operator">-</span>oci \<br>    <span class="token operator">-</span><span class="token operator">-</span>estargz<span class="token operator">-</span>record<span class="token operator">-</span><span class="token keyword">in</span><span class="token operator">=</span><span class="token operator">/</span>tmp<span class="token operator">/</span>record<span class="token punctuation">.</span>json \<br>    ubuntu<span class="token punctuation">:</span><span class="token number">21.04</span> ubuntu<span class="token punctuation">:</span><span class="token number">21.04</span><span class="token operator">-</span>ls</code></pre><h2 id=seekable-oci-(soci)>Seekable OCI (SOCI) <a href=#seekable-oci-(soci) class=direct-link>#</a></h2><p>Seekable OCI (SOCI) is a technology open sourced by AWS that enables containers to launch faster by lazily loading the container image. SOCI works by creating an index (SOCI Index) of the files within an existing container image. This index is a key enabler to launching containers faster, providing the capability of extracting an individual file from a container image before downloading the entire archive.<p>SOCI borrows some of the design principles from stargz-snapshotter, but takes a different approach.<p>A SOCI index is generated separately from the container image, and is stored in the registry as an <a href=https://github.com/opencontainers/artifacts>OCI Artifact</a> and linked back to the container image by <a href=https://github.com/opencontainers/tob/blob/main/proposals/wg-reference-types.md>OCI Reference Types</a>. This means that the container images do not need to be converted, image digests do not change, and image signatures remain valid.<p>Most OCI registries like DockerHub and ECR do not currently support the "referrers" feature. So you cannot use SOCI unless you run a local <a href=https://oras.land>ORAS</a> registry.<h2 id=conclusion>Conclusion <a href=#conclusion class=direct-link>#</a></h2><p>If you are looking to reduce container start time for your workloads, eStargz snapshotter is definitely worth a look. You’ll have to change your existing container build pipelines to add a step to convert images though. When SOCI support is available in OCI registries, you’ll be able to lazily-pull images without converting them first.<p>You’ll also have to install eStargz snapshotter on your nodes and configure containerd to use the plugin. Creating a custom AMI or using AWS Systems manager will be the best way to do that. You could also use a DaemonSet to configure the system, but keep in mind that you’ll need to account for restarting the containerd and kubelet.</p><share-widget><button aria-label=Share href=https://blog.realvarez.com/posts/estargz/ on-click=share><div></div></button></share-widget><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","headline":"Using eStargz to reduce container startup time on Amazon EKS","image":["https://blog.realvarez.com/img/remote/WQYt4-1920w.jpg","https://blog.realvarez.com/img/remote/1SDRNy-1920w.jpg","https://blog.realvarez.com/img/remote/Zzj0qB-1920w.jpg"],"author":"","genre":"Insert a schema.org genre","publisher":{"@type":"Organization","name":"","logo":{"@type":"ImageObject","url":"/img/favicon/favicon-192x192.png?hash=ae2c3e88f6"}},"url":"https://blog.realvarez.com/posts/estargz/","mainEntityOfPage":"https://blog.realvarez.com/posts/estargz/","datePublished":"2022-10-25","dateModified":"2023-04-09","description":"A container image bundles executable code, library, and configuration. Images contain everything an application needs to run. It is a best..."}</script><p>Published <time datetime=2022-10-25>25 Oct 2022</time></article></main><footer><a href=/about/ ></a></footer>